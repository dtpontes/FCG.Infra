# ?? Deploy com Azure Service Bus

## ?? **O que é criado:**

1. ? **Azure Service Bus Namespace**: `fcg-games-servicebus`
2. ? **3 Filas**:
   - `sale-processing-queue` (Games e Payments)
   - `payment-processing-queue` (Payments)
   - `response-payment-processing-queue` (Payments)
3. ? **Kubernetes Secret** com connection strings
4. ? **Cluster AKS** com todas as aplicações
5. ? **Auto Scaling (HPA)** configurado

---

## ?? **Como usar:**

### **Opção 1: Deploy SEM Service Bus (Simples)**
```cmd
deploy-simples.bat
```
- Não cria Service Bus
- Apps funcionam sem mensageria
- Mais rápido para testes

### **Opção 2: Deploy COM Service Bus (Completo)**
```cmd
deploy-with-servicebus.bat
```
- Cria Service Bus + Filas
- Configura mensageria entre apps
- Produção-ready

---

## ?? **Como funciona:**

### **1. Service Bus é criado no Azure**
```
Azure Service Bus
??? fcg-games-servicebus (namespace)
    ??? sale-processing-queue
    ??? payment-processing-queue
    ??? response-payment-processing-queue
```

### **2. Connection String é injetada via Secret**
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: servicebus-secrets
data:
  ServiceBus__ConnectionString: "Endpoint=sb://..."
  ServiceBus__SalesQueueName: "sale-processing-queue"
  ...
```

### **3. Pods leem do Secret**
```yaml
env:
- name: ServiceBus__ConnectionString
  valueFrom:
    secretKeyRef:
      name: servicebus-secrets
      key: ServiceBus__ConnectionString
      optional: true  # ? Funciona sem o secret também!
```

### **4. Apps .NET leem automaticamente**
```csharp
// IConfiguration já tem acesso via env vars
var connectionString = Configuration["ServiceBus:ConnectionString"];
```

---

## ?? **Arquitetura:**

```
???????????????????????????????????????
?      Azure Service Bus              ?
?  (fcg-games-servicebus)             ?
?                                     ?
?  ???????????????????????????????   ?
?  ? sale-processing-queue       ?   ?
?  ???????????????????????????????   ?
?  ???????????????????????????????   ?
?  ? payment-processing-queue    ?   ?
?  ???????????????????????????????   ?
?  ???????????????????????????????   ?
?  ? response-payment-...        ?   ?
?  ???????????????????????????????   ?
???????????????????????????????????????
           ?         ?
           ?         ?
    ???????????  ????????????
    ?  Games  ?  ? Payments ?
    ?   Pod   ?  ?   Pod    ?
    ???????????  ????????????
```

---

## ?? **Verificar Service Bus no Kubernetes:**

```cmd
# Ver o secret
kubectl get secret servicebus-secrets -n fcg-tutorial

# Ver as variáveis (Base64 decoded)
kubectl get secret servicebus-secrets -n fcg-tutorial -o jsonpath='{.data.ServiceBus__ConnectionString}' | base64 -d

# Ver se os pods têm acesso
kubectl exec -it <games-pod> -n fcg-tutorial -- env | grep ServiceBus
```

---

## ?? **Testar Mensageria:**

1. Acesse o Swagger do Games
2. Crie uma venda (POST /api/sales)
3. A mensagem vai para `sale-processing-queue`
4. O Payments consome e processa
5. Resposta vai para `response-payment-processing-queue`

---

## ?? **Custos:**

- **Service Bus Standard**: ~$10/mês (base) + $0.05 por 1M ops
- **Alternativa FREE**: Use **deploy-simples.bat** (sem Service Bus)

---

## ??? **Deletar Tudo:**

```cmd
az group delete --name FCG-Infra --yes --no-wait
```

Isso remove:
- ? Service Bus + Filas
- ? Cluster AKS
- ? Todos os recursos

---

## ?? **Mais Informações:**

- [Azure Service Bus Docs](https://learn.microsoft.com/en-us/azure/service-bus-messaging/)
- [Kubernetes Secrets](https://kubernetes.io/docs/concepts/configuration/secret/)
